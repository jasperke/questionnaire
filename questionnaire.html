<!DOCTYPE html>
<html lang="zh-tw">
<head>
	<meta charset="utf-8" />
	<title>問卷調查</title>
	<link rel="stylesheet" type="text/css" href="css/bootstrap.css">
	<script type="text/javascript" src="js/jquery.js" ></script>
	<script type="text/javascript" src="js/underscore-min.js" ></script>
	<script type="text/javascript" src="js/bootstrap.min.js" ></script>
	<script type="text/javascript" src="js/quizPool.js" ></script>
	<style type="text/css">
	* {
		font-family: "微軟正黑體";
	}
	html, body, h3 small, h4 small {
		font-size: 17px;
		font-family: "微軟正黑體";
	}
	#optlist {
		width: 90%;
		margin: 10px 5%;
	}
	#optlist a.btn-default:hover,
	#optlist a.btn-default.active {
		background: #F0F0F0;
	}
	#optlist a.text-danger,
	#optlist a.text-danger span {
		color: #B94A48;
	}
	#optlist a span {
		color: #999;
		vertical-align: middle;
		margin-right: 10px;
	}
	</style>
<script>

</script>
</head>
<body>
<form method="post" action="counter.php" class="form-inline" role="form" onsubmit="return isValidForm(this);">
	<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="index.html">問卷調查</a>
			</div>
			<div class="collapse navbar-collapse navbar-ex1-collapse pull-right">
				<ul class="nav navbar-nav">
					<li><a href="index.html">回首頁</a></li>
				</ul>
			</div>
		</div>
	</nav>
	<div class="container">
		<h3 style="margin:0;">
			<span id="questionnaire_name"></span> <small class="pull-right text-info">病患：<span id="p_id"></span> <span id="p_name"></span></small>
		</h3>
	</div>

	<div id="door" class="container paper">
		<div class="form-group" style="margin-right:20px;">
			<label class="text-muted" for="p_id">病歷號</label>
			<input type="text" class="form-control" style="width:auto;" id="p_id" name="p_id">
		</div>
		<div class="form-group">
			<label class="text-muted" for="p_name">姓名</label>
			<input type="text" class="form-control" style="width:auto;" id="p_name" name="p_name">
		</div>
		<div class="checkbox">
			<label style="margin-left: 20px;"><input name="p_gender" value="1" type="radio"> 男</label>
			<label style="margin-left: 20px;"><input name="p_gender" value="2" type="radio"> 女</label>
		</div>
		<br><br>
		<a id="startQ" onclick="startQuest();" class="btn btn-lg btn-default">開始</a>
	</div>

	<div id="paper" class="container paper" style="display:none">
		<span id="foreword"></span><br>
		<h1><span id="q_title"></span><span id="q_no" class="text-warning pull-right"></span></h1>
		<hr/>
		<div id="optlist" class="btn-group-vertical btn-group-lg"></div>
		<hr/>
		<a id="prevQ" onclick="setQuest(-1);" class="btn btn-lg btn-default"><i class="icon icon-chevron-left"></i> 上一題</a>
		<a id="nextQ" onclick="if(answer[q_no]===undefined){alert('請確實回答！');}else{setQuest(1);}" class="btn btn-lg btn-default pull-right">下一題 <i class="icon icon-chevron-right"></i></a>
	</div>
	<br/>
	<center id="send" style="display: none;">
		<button class="btn btn-lg btn-default"><i class="icon icon-remove"></i>  取　消</button>
		<button id="submitButton" class="btn btn-lg btn-success"><i class="icon icon-ok"></i>  送　出</button>
	</center>
	<script type="text/javascript">
		var q_no = 0,
			sub_q_no = -1,
			answer = [],
			quizzes,
			params={};

		function init(){
			_.each(location.search.replace(/^\?/,'').split('&'),function(s){
				s=s.split('=');
				params[s[0]]=s[1];
			});
			if(params.questionnaire===undefined||questionnaireMap[params.questionnaire]==undefined){
				window.location.replace('index.html');
			}
			$('#questionnaire_name').text(params.questionnaire);
			quizzes=questionnaireMap[params.questionnaire];
		}

		$(function(){
			init();

			setQuest(0);
			$("#optlist").on("click", "a.btn", function(event) {
				$(this).addClass("active text-danger")
				.find("span").removeClass("icon-unchecked").addClass("icon-check").end()
				.siblings("a.active").removeClass("active").removeClass("text-danger")
				.find("span").removeClass("icon-check").addClass("icon-unchecked");

				// 暫存答案至answer
				var isLastOne=false,
					sub_q_no=$(this).data('sub_q_no'),
					q_no=$(this).data('q_no'),
					val=$(this).data('val');
				if(sub_q_no==-1){ // 主問題
					if(answer[q_no]!==undefined){ // 之前已作答過
						var old_answer=answer[q_no].toString().split(':'); // ex. '1:0,1,2' 表示主問題選1,子問題群依序選0,1,2
						if(val!=old_answer[0]){ // 換答案, 須清掉子問題已填的答案(如果有的話)
							answer[q_no]=val;
						}else{ // 未換答案, 不需任何處理

						}
					}else{ // 頭一次作答
						answer[q_no]=val;
					}
				}else{ // 子問題
					var old_answer=answer[q_no].toString().split(':'),
						sub_answer=(old_answer[1]===undefined||old_answer[1]=='')?[]:old_answer[1].toString().split(',');
					sub_answer[sub_q_no]=val;
					answer[q_no]=old_answer[0]+':'+sub_answer.join(',');
				}

				if(event.originalEvent&&q_no<quizzes.length-1){ // user作答完, 自動換下一題
																// 切換上下題時, 標示已填答案也是trigger click event, 但不必換題
					setTimeout("setQuest(1);",300);
				}
			});
		});

		function setQuest(direction) {
			var quiz_id,
				sub_quizzes,
				curr_quiz_def=quizzes[q_no].toString().split(':'),
				next_quiz_def,
				prev_quiz_def;
				// ex. 'X6:X7,_X8,.....,_X22:A1,A2,...:...' 如有冒號, 冒號後表子問題群組, 可多個冒號區隔
				// 第1個冒號後接著的表第1子群問題(主問題選第1項時才秀)
				// 第2個冒號後接著的表第2子群問題(主問題選第2項時才秀)
				// 依此類推
			if(direction>0){ // next
				if(curr_quiz_def[1]===undefined){ // 當前問題無子問題群
					q_no+=direction;
					next_quiz_def=quizzes[q_no].toString().split(':');
					quiz_id=next_quiz_def[0];
				}else{ // 主問題某選項下有子問題群
					sub_quizzes=curr_quiz_def[parseInt(answer[q_no],10)+1];
					if(sub_quizzes!==undefined){ // 挑的答案選項有子問題
						sub_quizzes=sub_quizzes.toString().split(',');
						sub_q_no++;
						if(sub_quizzes[sub_q_no]!==undefined){ // 後面還有子問題
							quiz_id=sub_quizzes[sub_q_no];
						}else{ // 後面已無子問題, 秀下一個主問題
							sub_q_no=-1;
							q_no+=direction;
							next_quiz_def=quizzes[q_no].toString().split(':');
							quiz_id=next_quiz_def[0];
						}
					}else{
						sub_q_no=-1;
						q_no+=direction;
						next_quiz_def=quizzes[q_no].toString().split(':');
						quiz_id=next_quiz_def[0];
					}
				}
			}else if(direction<0){ // previous
				if(sub_q_no>-1){ // 在子問題群內
					sub_q_no--;
					sub_quizzes=curr_quiz_def[parseInt(answer[q_no],10)+1].toString().split(',');
					if(sub_q_no>=0){ // 前面有子問題
						quiz_id=sub_quizzes[sub_q_no];
					}else{ // 前已無子問題, 秀主問題
						quiz_id=curr_quiz_def[0];
					}
				}else{ // 需檢查前一主問題是否有子問題群
					q_no--;
					prev_quiz_def=quizzes[q_no].toString().split(':');
					if(prev_quiz_def[1]===undefined){ // 無子問題群
						quiz_id=prev_quiz_def[0];
					}else{ // 主問題某選項下有子問題群
						sub_quizzes=prev_quiz_def[parseInt(answer[q_no],10)+1];
						if(sub_quizzes!==undefined){ // 挑的答案選項有子問題
							sub_quizzes=sub_quizzes.toString().split(',');
							sub_q_no=sub_quizzes.length-1;
							quiz_id=sub_quizzes[sub_q_no];
						}else{
							quiz_id=prev_quiz_def[0];
						}
					}
				}
			}else{
				quiz_id=curr_quiz_def[0];
			}


			if(q_no==0&&sub_q_no==-1){
				$("#prevQ").hide();
			}else{
				$("#prevQ").show();
			}
			if(q_no>=quizzes.length-1){ // TODO: 若最後一題有子問題群, '下一題'會變得有點複雜, 有空再說...
										// 先只考慮是否是最後一大題
				$("#nextQ").hide();
				$("#send").show();
			} else {
				$("#nextQ").show();
				$("#send").hide();
			}


			$("#q_no").html( (q_no+1)+"/"+quizzes.length );
			$('#foreword').html((quizPool[quiz_id].foreword!==undefined)?'<div class="text-danger">'+quizPool[quiz_id].foreword+'</div>':'');
			$("#q_title").html(quizPool[quiz_id].quiz);
			$("#optlist").empty();

			$.each(quizPool[quiz_id].options||commonOptions, function(i){
				$("#optlist").append(
					$("<a/>").data({q_no:q_no,sub_q_no:sub_q_no,val:i}).addClass("btn btn-default text-left").append(
						$("<span/>").addClass("icon icon-unchecked")
					).append(this)
				);
			});
			if(answer[q_no]!==undefined){
				if(sub_q_no==-1){
					$("#optlist").find('a.btn').eq(parseInt(answer[q_no],10)).trigger('click');
				}else{
					sub_answer=answer[q_no].toString().split(':');
					if(sub_answer[1]!==undefined&&sub_answer[1]!=''){
						sub_answer=sub_answer[1].toString().split(',');
						if(sub_answer[sub_q_no]!==undefined){
							$("#optlist").find('a.btn').eq(sub_answer[sub_q_no]).trigger('click');
						}
					}
				}
			}
		}
		function saveQuestionnaire(q_name,f,answer,quizzes){
			$.ajax({
				url:'counter.php',
				dataType:'json',
				type:'POST',
				data:{
					questionnaire:q_name,
					p_id:f.p_id.value,
					p_name:f.p_name.value,
					p_gender:f.p_gender[0].checked?1:2,
					answer:answer,
					quizzes:quizzes
				},
				error:function(){
					alert('error');
				},
				success:function(data){
					if(data[0][0]==0){
						alert('資料儲存完畢！\n謝謝您的合作！');
						window.location.replace('index.html');
					}else{
						alert('錯誤！\n\n錯誤代碼：'+data[0][0]+'\n錯誤訊息：'+data[0][1]);
					}
				}
			});
		}
		function isValidForm(f){
			for(var i=quizzes.length-1; i>=0; i--){
				if(answer[i]===undefined){
					alert('請確實回答！');
					return false;
				}
			}
			saveQuestionnaire(params.questionnaire,f,answer,quizzes);
			return false;
		}
		function startQuest(){
			var f=document.forms[0];
			if(f.p_id.value==''||f.p_name.value==''||!(f.p_gender[0].checked||f.p_gender[1].checked)){
				alert('錯誤！\n\n資料輸入不完整！');
				return;
			}
			$('#p_id').text(f.p_id.value);
			$('#p_name').text(f.p_name.value);
			$('#door').hide();
			$('#paper').show();
		}
	</script>
</form>
</body>
</html>